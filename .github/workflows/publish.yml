name: Publish to NPM

on:
  push:
    branches:
      - master
      - main

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run validation
        run: npm run validate

  version-and-publish:
    name: Version and Publish
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install dependencies
        run: npm ci

      - name: Build package
        run: npm run build

      - name: Check for changes
        id: check_changes
        run: |
          # Get the last commit message
          COMMIT_MSG=$(git log -1 --pretty=%B)

          # Check if this is a version bump commit (to avoid loops)
          if [[ "$COMMIT_MSG" == *"chore(release):"* ]] || [[ "$COMMIT_MSG" == *"[skip ci]"* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine version bump type
        id: version_type
        if: steps.check_changes.outputs.skip == 'false'
        run: |
          # Get commit messages since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$LAST_TAG" ]; then
            # No tags exist, this is first release
            echo "type=minor" >> $GITHUB_OUTPUT
          else
            # Get commits since last tag
            COMMITS=$(git log $LAST_TAG..HEAD --pretty=%B)

            # Check for breaking changes
            if echo "$COMMITS" | grep -qiE "BREAKING CHANGE:|^[^:]+!:"; then
              echo "type=major" >> $GITHUB_OUTPUT
            # Check for features
            elif echo "$COMMITS" | grep -qiE "^feat(\(.*\))?:"; then
              echo "type=minor" >> $GITHUB_OUTPUT
            # Otherwise it's a patch
            else
              echo "type=patch" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Bump version
        id: bump_version
        if: steps.check_changes.outputs.skip == 'false'
        run: |
          VERSION_TYPE="${{ steps.version_type.outputs.type }}"

          # Bump version
          NEW_VERSION=$(npm version $VERSION_TYPE -m "chore(release): %s [skip ci]")
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Push changes
          git push origin HEAD --follow-tags

      - name: Calculate bundle size
        id: bundle_size
        if: steps.check_changes.outputs.skip == 'false'
        run: |
          # Get sizes in bytes
          CJS_SIZE=$(stat -f%z dist/index.js 2>/dev/null || stat -c%s dist/index.js)
          ESM_SIZE=$(stat -f%z dist/index.mjs 2>/dev/null || stat -c%s dist/index.mjs)

          # Create tarball to check final package size
          npm pack
          PACKAGE_SIZE=$(stat -f%z *.tgz 2>/dev/null || stat -c%s *.tgz)

          # Convert to KB
          CJS_KB=$((CJS_SIZE / 1024))
          ESM_KB=$((ESM_SIZE / 1024))
          PKG_KB=$((PACKAGE_SIZE / 1024))

          echo "cjs_size=${CJS_KB}KB" >> $GITHUB_OUTPUT
          echo "esm_size=${ESM_KB}KB" >> $GITHUB_OUTPUT
          echo "package_size=${PKG_KB}KB" >> $GITHUB_OUTPUT

          # Clean up tarball
          rm *.tgz

      - name: Publish to NPM
        if: steps.check_changes.outputs.skip == 'false'
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release
        if: steps.check_changes.outputs.skip == 'false'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.bump_version.outputs.new_version }}
          release_name: Release ${{ steps.bump_version.outputs.new_version }}
          body: |
            ## Bundle Size
            - CJS: ${{ steps.bundle_size.outputs.cjs_size }}
            - ESM: ${{ steps.bundle_size.outputs.esm_size }}
            - Package: ${{ steps.bundle_size.outputs.package_size }}

            ## Changes
            See commit history for detailed changes.
          draft: false
          prerelease: false

      - name: Comment on related PRs
        if: steps.check_changes.outputs.skip == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ steps.bump_version.outputs.new_version }}';
            const cjsSize = '${{ steps.bundle_size.outputs.cjs_size }}';
            const esmSize = '${{ steps.bundle_size.outputs.esm_size }}';
            const pkgSize = '${{ steps.bundle_size.outputs.package_size }}';

            const comment = `ðŸš€ **Published ${version}**\n\n` +
              `ðŸ“¦ **Bundle Size:**\n` +
              `- CJS: ${cjsSize}\n` +
              `- ESM: ${esmSize}\n` +
              `- Package: ${pkgSize}\n\n` +
              `Available on npm: https://www.npmjs.com/package/@ai-integrator/core`;

            // Find recently merged PRs
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed',
              sort: 'updated',
              direction: 'desc',
              per_page: 5
            });

            // Comment on merged PRs from the last hour
            const oneHourAgo = Date.now() - (60 * 60 * 1000);
            for (const pr of prs) {
              if (pr.merged_at && new Date(pr.merged_at).getTime() > oneHourAgo) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: comment
                });
              }
            }
